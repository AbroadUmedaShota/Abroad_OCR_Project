# 要件定義書

## 1. プロジェクト概要
- **名称**: オフライン日本語手書き対応・検索可能 PDF 生成アプリ
- **目的**: 機微情報を含む PDF 文書を完全オフライン環境で OCR 処理し、検索可能 PDF と CSV を生成する。
- **現状**: CLI 版 PoC により「PDF→画像変換→PP-OCRv5 実行→CSV 出力」までを自動化済み。GUI、パイプライン管理、PDF ビルダーは今後実装予定。

## 2. ステークホルダー
| 区分 | 役割 | 期待値 |
| ---- | ---- | ------ |
| プロダクトオーナー | 要件定義・優先順位付け | 高精度でオフライン稼働する OCR 基盤の確立 |
| 開発チーム | 設計・実装・テスト | 要件通りの機能・品質達成 |
| 運用担当 | 導入・保守 | バッチ処理や GUI を通じた安定運用 |
| エンドユーザー | OCR 実行 | 検索可能 PDF と CSV による業務効率化 |

## 3. 用語定義
| 用語 | 定義 |
| ---- | ---- |
| CER | Character Error Rate = (置換 + 挿入 + 削除) / 総文字数 |
| IoU | Intersection over Union。検出バウンディングボックスと正解の重なり度合い |
| Invisible-Text Layer | PDF 内に埋め込む不可視テキスト層。検索可能化に用いる |
| PoC | Proof of Concept。概念実証段階の機能実装 |

## 4. スコープ
### 4.1 対象
- 画像 PDF / 混在 PDF (テキスト + 画像) の全ページ。
- 漢字、かな、英字、数字、記号、手書き・印字を含む文書。

### 4.2 非対象
- クラウド経由の OCR 処理。
- PDF 以外の入力形式 (画像単体等)。
- 英語以外の GUI 表記ローカライズ (初期は日本語 UI を想定)。

## 5. 前提・制約
- 完全オフラインで動作すること (外部 API 禁止)。
- Windows / macOS / Linux のデスクトップ環境で実行可能なこと。
- 処理対象 PDF は 600 DPI 以下、ページ数 500 未満を想定。
- OSS ライセンス順守 (PaddleOCR, Tesseract, OpenVINO 等)。

## 6. 機能要件
### 6.1 入力処理
1. PDF をページ単位の画像 (PNG) に変換できること。
2. DPI・ページサイズを保ったまま変換結果を管理すること。

### 6.2 OCR パイプライン
1. 複数 OCR エンジン (Tesseract、PP-OCRv5、Mistral-OCR LoRA) の出力を受け取り、重み付き投票で統合すること。
2. KenLM などの言語モデルによる後処理で文字列補正ができること。
3. 空白トークンを保持し、レイアウトに応じたスペースを再現すること。
4. 低信頼スコアの領域に再推論リトライ機構を備えること。

### 6.3 出力
1. 検索可能 PDF を生成し、元 PDF と同一ディレクトリに保存すること。
2. CSV 形式 (列: `page`, `block_id`, `x0`, `y0`, `x1`, `y1`, `text`, `confidence`) で OCR 結果を出力すること。
3. オプション指定により PDF+CSV を ZIP 化できること。
4. 低信頼度行にハイライト注釈を付与すること。

### 6.4 UI / 操作
1. CLI から単一コマンドで処理実行できること。
2. 将来的に GUI (Tauri + React) を提供し、ドラッグ&ドロップ入力や進捗表示を行うこと。
3. GUI 上で低信頼テキストをインライン編集し即時反映できること。

### 6.5 運用・管理
1. パイプラインマネージャーによりジョブキュー管理と並列実行を行うこと。
2. 設定を JSON などの外部ファイルで管理し、環境ごとに切り替え可能にすること。

## 7. 非機能要件
| 区分 | 要件 |
| ---- | ---- |
| 性能 | A4 300 DPI PDF 50 ページを 10 分以内 (GPU 利用可)。|
| 精度 | 印字 CER ≤ 2%、手書き CER ≤ 5%、IoU ≥ 0.80、スペース誤り率 ≤ 1%。|
| 可用性 | 1 日 100 バッチ処理に耐える安定性。|
| セキュリティ | 完全オフライン。ログはローカル暗号化フォルダに保存。|
| 保守性 | OCR エンジンをプラグイン差し替え可能な設計。|
| 移植性 | Windows/macOS/Linux 向けバイナリを提供。|

## 8. データ要件
- 学習/評価用データは社内で匿名化済みの PDF + 正解テキストを用意する。
- KenLM 用語彙: ドメイン辞書 + 一般日本語コーパス。
- モデル重みはローカルストレージでバージョン管理 (例: `models/ppocr/`, `models/mistral_lora/`)。

## 9. 外部インターフェース
- ファイル入出力: ローカルファイルシステム。
- GPU/CPU: PaddlePaddle C++ 推論ランタイム、OpenVINO。
- 監視: ローカルログファイル (JSON Lines) と簡易ダッシュボード (今後の拡張)。

## 10. 運用・保守要件
- ログ収集と再処理用のコマンド (例: `--reprocess`) を提供。
- モデル更新時は Canary モード (一部ページで新モデル評価) を提供。
- パイプラインの DAG 設定をバージョン管理し、Git 上でレビュー可能にする。

## 11. テスト・受け入れ基準
| テスト観点 | 内容 | 受け入れ基準 |
| ---------- | ---- | --------- |
| 単体テスト | 画像変換、OCR モック、CER/IoU 算出ユーティリティ | 既存テスト (例: `tests/test_ocr_poc.py`) が全て成功 |
| システムテスト | PDF 入力から PDF/CSV 出力までの一連フロー | 指標を満たし、エラーなく完了 |
| ユーザ受入 | GUI での操作性、CSV レイアウト | 想定業務シナリオで利用可能と判断 |

## 12. 今後の課題
- GUI 実装とユーザ編集フローの確立。
- KenLM 補正の本格導入とパフォーマンス最適化。
- アンサンブル精度向上 (各エンジンの個別チューニング)。
- PDF ビルダーの Invisible-Text レイヤ実装とハイライト処理。
- オフラインアップデート配布機構の設計。

